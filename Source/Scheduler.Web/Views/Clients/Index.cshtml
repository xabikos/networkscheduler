@model IEnumerable<Scheduler.Common.ClientDevice>

@{
    ViewBag.Title = "Clients management";
}

<table id="clients" class="table table-striped table-bordered" cellspacing="0" width="100%">
    <thead>
        <tr>
            <th>
                Index
            </th>
            <th>
                Name
            </th>
            <th>
                IP Address
            </th>
            <th>
                Status
            </th>
            <th>Commands</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var client in Model)
        {
            <tr>
                <td></td>
                <td>@client.Name</td>
                <td>@client.IpAddress</td>
                <td>Getting Status</td>
                <td></td>
            </tr>
        }
    </tbody>
</table>

@section scripts{
    <script type="text/javascript">
        $(function () {

            var clientsTable = $('#clients').DataTable({
                "fnRowCallback": function(nRow, aData, iDisplayIndex, iDisplayIndexFull) {
                    $('td:eq(0)', nRow).html(iDisplayIndex);
                    if (aData[3] === "Connected") {
                        $('td:eq(3)', nRow).html('Connected');
                    } else {
                        $('td:eq(3)', nRow).html('Disconnected');
                    }
                }
            });

            var connection = $.hubConnection('http://localhost:8080/');
            var proxy = connection.createHubProxy('ManagementHub');

            proxy.on('clientAdded', function (clientData) {
                clientsTable.row.add([0, clientData.name, clientData.ipAddress, 'Connected', '']).draw();
            });

            proxy.on('clientDisconected', function (clientName) {
                $("tr:contains('" + clientName + "')").each(function () {
                    $('td:eq(3)', this).html('Disconnected');
                });
            });

            connection.start()
                .done(function () {

                })
                .fail(function () { alert("Could not Connect!"); });

            $("#broadcast").click(function () {
                proxy.invoke('Publish', $("#dataToSend").val(), 'Product');
            });

            

        });
    </script>
}